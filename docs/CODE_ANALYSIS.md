# Code Analysis & Architecture Report

This report documents the architectural patterns, security invariants, and code quality standards of the FlowPay Core system.

## üèõÔ∏è Architectural Integrity

### 1. Hexagonal Design (Ports & Adapters)
FlowPay follows a clean separation of concerns:
- **Core (Nucleus)**: The `/src/core` directory contains the pure business logic and state machine. It has ZERO dependencies on external frameworks or HTTP logic.
- **Rails (Adapters)**: The `/src/rails` directory implements the `RailAdapter` interface. Each provider (Ef√≠, MP, etc.) is an isolated plugin.
- **Delivery (HTTP)**: The `/src/http` directory handles the interface with the outside world (Fastify), mapping requests to core services.

### 2. State Machine Immutability
The `ChargeStatus` transitions are strictly managed in `src/core/domain/stateMachine.ts`. 
- **Rule**: Once a charge is `PAID`, no further transitions are allowed.
- **Implication**: This eliminates race conditions during webhook processing and prevents double-unlocking.

## üîí Security Posture

### 1. Cryptographic Invariants
- **Webhook Verification**: All adapters MUST verify signatures using the provider's specific secret before the core processes the event.
- **Signed Proof of Purchase**: Every unlock results in a JSON receipt signed with HMAC-SHA256 (`src/core/security/signatures.ts`). This ensures that the buyer cannot forge access permissions.

### 2. Idempotency & Replay Protection
- **Idempotency Key**: Required for all charge creations. Stored in the `idempotencyKeys` map (or persistent DB) to prevent duplicate payments.
- **Event ID Store**: Every processed webhook event ID is recorded. If the same event is received again, the system ignores it without triggering duplicate business logic.

## üìà Quality Metrics (Automatic Verification)

FlowPay uses the following tools to maintain code quality:
- **TypeScript (TSC)**: Strict mode enabled to prevent type-related runtime errors.
- **Security Audits**: Continuous dependency auditing via `npm audit`.
- **Atomic Commits**: Following the NŒû√ò Protocol, every change is validated via build before commit.

## üöÄ Optimization Opportunities

- **Settlement Logic**: The current `SETTLEMENT.md` plan is implementable as a background worker (e.g., BullMQ) to handle batch conversions in a way that doesn't impact HTTP performance.
- **Persistent Store**: Migrating from `MemoryStore` to `PostgresStore` (via Drizzle or Prisma) is the primary step for production scaling.

---
*Generated by FlowPay Analysis Engine.*
